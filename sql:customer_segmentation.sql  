-- This query prepares the data for RFM (Recency, Frequency, Monetary) analysis.
-- It calculates the last purchase date, total number of orders (frequency),
-- and total money spent (monetary) for each customer.

-- I used a CTE to aggregate order payments first to get the total value per order.
WITH order_payments_agg AS (
    SELECT
        order_id,
        SUM(payment_value) as total_payment_value
    FROM order_payments
    GROUP BY order_id
)
-- Main query to calculate RFM metrics for each customer
SELECT
    c.customer_unique_id,
    -- Recency: Days since the last purchase
    JULIANDAY('2018-10-17') - JULIANDAY(MAX(o.order_purchase_timestamp)) AS recency,
    -- Frequency: Total number of orders made
    COUNT(DISTINCT o.order_id) AS frequency,
    -- Monetary: Total amount spent by the customer
    SUM(opa.total_payment_value) AS monetary
FROM
    customers c
JOIN
    orders o ON c.customer_id = o.customer_id
JOIN
    order_payments_agg opa ON o.order_id = opa.order_id
-- Filter for delivered orders to ensure valid transactions
WHERE
    o.order_status = 'delivered'
GROUP BY
    c.customer_unique_id
ORDER BY
    monetary DESC;